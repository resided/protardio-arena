<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROTARDIO ARENA - LET IT RIP!</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: radial-gradient(ellipse at center, #1a0a2e 0%, #0a0a0a 70%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        /* 90s style scanlines */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        .logo {
            font-family: 'Bangers', cursive;
            font-size: 4rem;
            color: #ff0;
            text-shadow:
                4px 4px 0 #f00,
                8px 8px 0 #00f,
                0 0 30px #ff0,
                0 0 60px #f00;
            letter-spacing: 8px;
            animation: logoGlow 1s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            from { text-shadow: 4px 4px 0 #f00, 8px 8px 0 #00f, 0 0 30px #ff0; }
            to { text-shadow: 4px 4px 0 #f00, 8px 8px 0 #00f, 0 0 60px #ff0, 0 0 100px #f00; }
        }

        .tagline {
            font-family: 'Bangers', cursive;
            font-size: 2rem;
            color: #0ff;
            margin-top: 10px;
            text-shadow: 2px 2px 0 #f0f;
            animation: flash 0.5s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .connect-btn {
            font-family: 'Bangers', cursive;
            background: linear-gradient(180deg, #ff0 0%, #f80 50%, #f00 100%);
            border: 4px solid #fff;
            padding: 15px 50px;
            font-size: 1.8rem;
            color: #000;
            cursor: pointer;
            margin-top: 30px;
            text-transform: uppercase;
            letter-spacing: 3px;
            box-shadow: 0 0 20px #ff0, inset 0 0 20px rgba(255,255,255,0.3);
            transition: all 0.2s;
        }

        .connect-btn:hover {
            transform: scale(1.1) rotate(-2deg);
            box-shadow: 0 0 40px #ff0, 0 0 80px #f00;
        }

        .wallet-info {
            background: linear-gradient(90deg, #f0f, #0ff);
            padding: 3px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 20px;
        }

        .wallet-info-inner {
            background: #000;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* ARENA */
        .arena {
            background: radial-gradient(circle, #2a1a4a 0%, #0a0a1a 100%);
            border: 5px solid;
            border-image: linear-gradient(45deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f) 1;
            border-radius: 50%;
            width: 400px;
            height: 400px;
            margin: 40px auto;
            position: relative;
            box-shadow:
                0 0 50px rgba(255,0,255,0.5),
                inset 0 0 100px rgba(0,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .arena-inner {
            width: 90%;
            height: 90%;
            border: 3px dashed rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .beyblade {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            position: absolute;
            border: 4px solid #fff;
            box-shadow: 0 0 30px currentColor;
            overflow: hidden;
            transition: all 0.3s;
        }

        .beyblade img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .beyblade.spinning {
            animation: spin 0.1s linear infinite;
        }

        .beyblade.winner {
            animation: winSpin 0.5s ease-out forwards, pulse 0.3s ease-in-out infinite;
            box-shadow: 0 0 50px #ff0, 0 0 100px #f00;
        }

        .beyblade.loser {
            animation: flyOut 1s ease-in forwards;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes winSpin {
            from { transform: rotate(0deg) scale(1); }
            to { transform: rotate(720deg) scale(1.3); }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 50px #ff0; }
            50% { box-shadow: 0 0 100px #f00, 0 0 150px #ff0; }
        }

        @keyframes flyOut {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
            100% { transform: translate(300px, -200px) rotate(1080deg); opacity: 0; }
        }

        .beyblade-1 {
            left: 50px;
            color: #f00;
        }

        .beyblade-2 {
            right: 50px;
            color: #00f;
        }

        .vs-text {
            font-family: 'Bangers', cursive;
            font-size: 3rem;
            color: #ff0;
            text-shadow: 3px 3px 0 #f00;
            z-index: 10;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .control-panel {
            background: linear-gradient(180deg, #1a1a3a 0%, #0a0a1a 100%);
            border: 3px solid #f0f;
            padding: 25px;
            position: relative;
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f);
            z-index: -1;
            animation: borderGlow 3s linear infinite;
        }

        @keyframes borderGlow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .control-panel h2 {
            font-family: 'Bangers', cursive;
            font-size: 1.8rem;
            color: #0ff;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #f0f;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #000;
            border: 2px solid #0ff;
            color: #0ff;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: #ff0;
            box-shadow: 0 0 20px #ff0;
        }

        .rip-btn {
            font-family: 'Bangers', cursive;
            width: 100%;
            background: linear-gradient(180deg, #f00 0%, #900 100%);
            border: 3px solid #ff0;
            padding: 20px;
            font-size: 1.5rem;
            color: #ff0;
            cursor: pointer;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.2s;
        }

        .rip-btn:hover {
            background: linear-gradient(180deg, #ff0 0%, #f80 100%);
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 0 30px #ff0;
        }

        .rip-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Open Battles List */
        .battles-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .battle-item {
            background: rgba(0,0,0,0.5);
            border: 2px solid #0ff;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .battle-item:hover {
            border-color: #ff0;
            box-shadow: 0 0 20px rgba(255,255,0,0.3);
        }

        .battle-stake {
            font-size: 1.3rem;
            color: #ff0;
        }

        .join-btn {
            font-family: 'Bangers', cursive;
            background: #0f0;
            border: 2px solid #fff;
            padding: 10px 25px;
            color: #000;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .join-btn:hover {
            background: #ff0;
            transform: scale(1.1);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #f0f;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-family: 'Bangers', cursive;
            font-size: 2rem;
            color: #ff0;
        }

        .stat-label {
            color: #888;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        /* Battle Result Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            text-align: center;
            animation: modalPop 0.5s ease-out;
        }

        @keyframes modalPop {
            from { transform: scale(0) rotate(-180deg); }
            to { transform: scale(1) rotate(0deg); }
        }

        .result-text {
            font-family: 'Bangers', cursive;
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .result-text.win {
            color: #ff0;
            text-shadow: 4px 4px 0 #f00, 0 0 50px #ff0;
            animation: winText 0.5s ease-in-out infinite alternate;
        }

        .result-text.lose {
            color: #f00;
            text-shadow: 4px 4px 0 #000;
        }

        @keyframes winText {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .prize-text {
            font-size: 2rem;
            color: #0ff;
        }

        .close-modal {
            font-family: 'Bangers', cursive;
            background: #f0f;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            margin-top: 30px;
        }

        .hidden { display: none; }
        #content { display: none; }

        /* Sparks effect */
        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff0;
            border-radius: 50%;
            animation: sparkFly 0.5s ease-out forwards;
        }

        @keyframes sparkFly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .logo { font-size: 2.5rem; }
            .arena { width: 300px; height: 300px; }
            .beyblade { width: 80px; height: 80px; }
            .controls { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">PROTARDIO ARENA</div>
            <div class="tagline">LET IT RIP!</div>

            <div id="connectSection">
                <button class="connect-btn" onclick="connectWallet()">ENTER THE ARENA</button>
            </div>

            <div id="walletSection" class="hidden">
                <div class="wallet-info">
                    <div class="wallet-info-inner">
                        <span id="walletAddress"></span> | ARBITRUM
                    </div>
                </div>
            </div>
        </header>

        <div id="content">
            <!-- THE ARENA -->
            <div class="arena" id="arena">
                <div class="arena-inner">
                    <div class="beyblade beyblade-1" id="blade1">
                        <img src="" alt="Player 1" id="blade1Img">
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="beyblade beyblade-2" id="blade2">
                        <img src="" alt="Player 2" id="blade2Img">
                    </div>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="totalBattles">0</div>
                    <div class="stat-label">Total Battles</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="yourWins">0</div>
                    <div class="stat-label">Your Wins</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="yourLosses">0</div>
                    <div class="stat-label">Your Losses</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="yourEarnings">0</div>
                    <div class="stat-label">ETH Won</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-panel">
                    <h2>CREATE BATTLE</h2>
                    <input type="number" id="myTokenId" placeholder="Your Protardio Token ID">
                    <input type="number" id="stakeAmount" placeholder="Stake (ETH)" step="0.001" min="0.001">
                    <button class="rip-btn" onclick="createBattle()">LET IT RIP!</button>
                </div>

                <div class="control-panel">
                    <h2>OPEN BATTLES</h2>
                    <div class="battles-list" id="battlesList">
                        <p style="color: #888; text-align: center;">No battles waiting...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="result-text" id="resultText">VICTORY!</div>
            <div class="prize-text" id="prizeText">You won 0.195 ETH!</div>
            <button class="close-modal" onclick="closeModal()">CONTINUE</button>
        </div>
    </div>

    <script>
        // Contract config - UPDATE AFTER DEPLOY
        const CONTRACT_ADDRESS = "YOUR_CONTRACT_ADDRESS_HERE";
        const ARBITRUM_CHAIN_ID = 42161;
        const IPFS_GATEWAY = "https://ipfs.io/ipfs/";
        const PROTARDIO_METADATA_BASE = "bafybeicl67a4psuapqrme7w7x4drti24sun66bft2yxcagblamufgxtn2i";
        const PROTARDIO_IMAGE_BASE = "bafybeiefdh5ryzudhw2y2qvhqbigxigmx4kqkrabqqlnsv3twiz6mphida";

        const ABI = [
            "function createBattle(uint256 tokenId) payable",
            "function joinBattle(uint256 battleId, uint256 tokenId) payable",
            "function cancelBattle(uint256 battleId)",
            "function getOpenBattles() view returns (uint256[])",
            "function getBattle(uint256) view returns (address player1, address player2, uint256 stake, uint256 p1TokenId, uint256 p2TokenId, bool active)",
            "function getStats(address) view returns (uint256 wins, uint256 losses, uint256 earnings)",
            "function totalBattles() view returns (uint256)",
            "function minStake() view returns (uint256)",
            "event LetItRip(uint256 indexed battleId, address indexed winner, address indexed loser, uint256 prize)"
        ];

        let provider, signer, contract, userAddress;

        // Get Protardio image URL
        function getProtardioImage(tokenId) {
            return `${IPFS_GATEWAY}${PROTARDIO_IMAGE_BASE}/${tokenId}.png`;
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert('Install MetaMask!');
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Switch to Arbitrum
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== ARBITRUM_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xa4b1' }]
                        });
                    } catch (e) {
                        if (e.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0xa4b1',
                                    chainName: 'Arbitrum One',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://arb1.arbitrum.io/rpc'],
                                    blockExplorerUrls: ['https://arbiscan.io']
                                }]
                            });
                        }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                }

                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                document.getElementById('connectSection').classList.add('hidden');
                document.getElementById('walletSection').classList.remove('hidden');
                document.getElementById('walletAddress').textContent =
                    userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                document.getElementById('content').style.display = 'block';

                // Set default beyblade images
                document.getElementById('blade1Img').src = getProtardioImage(1);
                document.getElementById('blade2Img').src = getProtardioImage(2);

                await loadStats();
                await loadOpenBattles();

                // Start spinning animation
                document.getElementById('blade1').classList.add('spinning');
                document.getElementById('blade2').classList.add('spinning');

            } catch (error) {
                console.error(error);
                alert('Connection failed: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                const [totalBattles, stats] = await Promise.all([
                    contract.totalBattles(),
                    contract.getStats(userAddress)
                ]);

                document.getElementById('totalBattles').textContent = totalBattles.toString();
                document.getElementById('yourWins').textContent = stats.wins.toString();
                document.getElementById('yourLosses').textContent = stats.losses.toString();
                document.getElementById('yourEarnings').textContent =
                    parseFloat(ethers.formatEther(stats.earnings)).toFixed(3);
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        async function loadOpenBattles() {
            try {
                const battleIds = await contract.getOpenBattles();
                const container = document.getElementById('battlesList');

                if (battleIds.length === 0) {
                    container.innerHTML = '<p style="color: #888; text-align: center;">No battles waiting... Create one!</p>';
                    return;
                }

                let html = '';
                for (const id of battleIds) {
                    const battle = await contract.getBattle(id);
                    if (!battle.active) continue;

                    const isYours = battle.player1.toLowerCase() === userAddress.toLowerCase();
                    html += `
                        <div class="battle-item">
                            <div>
                                <div style="color: #0ff;">Protardio #${battle.p1TokenId}</div>
                                <div style="font-size: 0.8rem; color: #888;">${battle.player1.slice(0,6)}...${battle.player1.slice(-4)}</div>
                            </div>
                            <div class="battle-stake">${ethers.formatEther(battle.stake)} ETH</div>
                            ${isYours ?
                                '<span style="color: #888;">Your Battle</span>' :
                                `<button class="join-btn" onclick="joinBattle(${id}, '${battle.stake}', ${battle.p1TokenId})">FIGHT!</button>`
                            }
                        </div>
                    `;
                }

                container.innerHTML = html || '<p style="color: #888; text-align: center;">No battles waiting...</p>';
            } catch (e) {
                console.error('Load battles error:', e);
            }
        }

        async function createBattle() {
            const tokenId = document.getElementById('myTokenId').value;
            const stake = document.getElementById('stakeAmount').value;

            if (!tokenId || !stake) {
                alert('Enter your Token ID and stake amount!');
                return;
            }

            try {
                // Update arena with your beyblade
                document.getElementById('blade1Img').src = getProtardioImage(tokenId);

                const tx = await contract.createBattle(tokenId, {
                    value: ethers.parseEther(stake)
                });
                await tx.wait();

                await loadOpenBattles();
                await loadStats();

                alert('Battle created! Waiting for challenger...');
            } catch (e) {
                console.error(e);
                alert('Error: ' + (e.reason || e.message));
            }
        }

        async function joinBattle(battleId, stakeWei, opponentTokenId) {
            const tokenId = prompt('Enter your Protardio Token ID:');
            if (!tokenId) return;

            try {
                // Setup arena visuals
                const blade1 = document.getElementById('blade1');
                const blade2 = document.getElementById('blade2');
                document.getElementById('blade1Img').src = getProtardioImage(opponentTokenId);
                document.getElementById('blade2Img').src = getProtardioImage(tokenId);

                // Intense spinning
                blade1.classList.add('spinning');
                blade2.classList.add('spinning');
                blade1.style.animationDuration = '0.05s';
                blade2.style.animationDuration = '0.05s';

                // Create sparks
                createSparks();

                const tx = await contract.joinBattle(battleId, tokenId, { value: stakeWei });
                const receipt = await tx.wait();

                // Find the LetItRip event
                const ripEvent = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'LetItRip';
                    } catch { return false; }
                });

                if (ripEvent) {
                    const parsed = contract.interface.parseLog(ripEvent);
                    const winner = parsed.args.winner;
                    const prize = ethers.formatEther(parsed.args.prize);
                    const youWon = winner.toLowerCase() === userAddress.toLowerCase();

                    // Battle animation
                    setTimeout(() => {
                        blade1.style.animationDuration = '0.1s';
                        blade2.style.animationDuration = '0.1s';
                    }, 1000);

                    setTimeout(() => {
                        if (youWon) {
                            blade2.classList.remove('spinning');
                            blade2.classList.add('winner');
                            blade1.classList.remove('spinning');
                            blade1.classList.add('loser');
                        } else {
                            blade1.classList.remove('spinning');
                            blade1.classList.add('winner');
                            blade2.classList.remove('spinning');
                            blade2.classList.add('loser');
                        }

                        // Show result
                        showResult(youWon, prize);
                    }, 2000);
                }

                await loadStats();
                await loadOpenBattles();

            } catch (e) {
                console.error(e);
                alert('Error: ' + (e.reason || e.message));
                resetArena();
            }
        }

        function createSparks() {
            const arena = document.getElementById('arena');
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const spark = document.createElement('div');
                    spark.className = 'spark';
                    spark.style.left = '50%';
                    spark.style.top = '50%';
                    spark.style.setProperty('--tx', (Math.random() - 0.5) * 200 + 'px');
                    spark.style.setProperty('--ty', (Math.random() - 0.5) * 200 + 'px');
                    spark.style.background = ['#ff0', '#f00', '#0ff', '#f0f'][Math.floor(Math.random() * 4)];
                    arena.appendChild(spark);
                    setTimeout(() => spark.remove(), 500);
                }, i * 100);
            }
        }

        function showResult(won, prize) {
            const modal = document.getElementById('resultModal');
            const resultText = document.getElementById('resultText');
            const prizeText = document.getElementById('prizeText');

            if (won) {
                resultText.textContent = 'VICTORY!';
                resultText.className = 'result-text win';
                prizeText.textContent = `You won ${parseFloat(prize).toFixed(4)} ETH!`;
            } else {
                resultText.textContent = 'DEFEAT!';
                resultText.className = 'result-text lose';
                prizeText.textContent = 'Better luck next time...';
            }

            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('resultModal').classList.remove('show');
            resetArena();
        }

        function resetArena() {
            const blade1 = document.getElementById('blade1');
            const blade2 = document.getElementById('blade2');

            blade1.className = 'beyblade beyblade-1 spinning';
            blade2.className = 'beyblade beyblade-2 spinning';
            blade1.style.animationDuration = '0.1s';
            blade2.style.animationDuration = '0.1s';
        }

        // Listen for events
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }

        // Refresh battles periodically
        setInterval(() => {
            if (contract) loadOpenBattles();
        }, 10000);
    </script>
</body>
</html>
